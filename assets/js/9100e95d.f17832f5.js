"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[8357],{9018:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>d,frontMatter:()=>a,metadata:()=>o,toc:()=>c});var i=n(5893),s=n(1151);const a={title:"@upstream"},r=void 0,o={id:"operators/upstream",title:"@upstream",description:"The upstream directive allows you to control various aspects of the upstream server connection. This includes settings like connection timeouts, keep-alive intervals, and more. If not specified, default values are used.",source:"@site/docs/operators/upstream.md",sourceDirName:"operators",slug:"/operators/upstream",permalink:"/docs/operators/upstream",draft:!1,unlisted:!1,editUrl:"https://github.com/tailcallhq/tailcallhq.github.io/tree/develop/docs/operators/upstream.md",tags:[],version:"current",frontMatter:{title:"@upstream"},sidebar:"tutorialSidebar",previous:{title:"@server",permalink:"/docs/operators/server"}},l={},c=[{value:"poolIdleTimeout",id:"poolidletimeout",level:2},{value:"poolMaxIdlePerHost",id:"poolmaxidleperhost",level:2},{value:"keepAliveInterval",id:"keepaliveinterval",level:2},{value:"keepAliveTimeout",id:"keepalivetimeout",level:2},{value:"keepAliveWhileIdle",id:"keepalivewhileidle",level:2},{value:"proxy",id:"proxy",level:2},{value:"connectTimeout",id:"connecttimeout",level:2},{value:"timeout",id:"timeout",level:2},{value:"tcpKeepAlive",id:"tcpkeepalive",level:2},{value:"userAgent",id:"useragent",level:2},{value:"allowedHeaders",id:"allowedheaders",level:2},{value:"baseURL",id:"baseurl",level:2},{value:"httpCache",id:"httpcache",level:2},{value:"Tips",id:"tips",level:3},{value:"batch",id:"batch",level:2}];function h(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"upstream"})," directive allows you to control various aspects of the upstream server connection. This includes settings like connection timeouts, keep-alive intervals, and more. If not specified, default values are used."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:"showLineNumbers",children:"schema @upstream(...[UpstreamSetting]...){\n    query: Query\n    mutation: Mutation\n}\n"})}),"\n",(0,i.jsxs)(t.p,{children:["The various ",(0,i.jsx)(t.code,{children:"UpstreamSetting"})," options and their details are explained below."]}),"\n",(0,i.jsx)(t.h2,{id:"poolidletimeout",children:"poolIdleTimeout"}),"\n",(0,i.jsx)(t.p,{children:"The time in seconds that the connection pool will wait before closing idle connections."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:"showLineNumbers",children:'schema @upstream(poolIdleTimeout: 60, baseURL: "http://jsonplaceholder.typicode.com") {\n  query: Query\n  mutation: Mutation\n}\n'})}),"\n",(0,i.jsx)(t.h2,{id:"poolmaxidleperhost",children:"poolMaxIdlePerHost"}),"\n",(0,i.jsx)(t.p,{children:"The maximum number of idle connections that will be maintained per host."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:"showLineNumbers",children:'schema @upstream(poolMaxIdlePerHost: 60, baseURL: "http://jsonplaceholder.typicode.com") {\n  query: Query\n  mutation: Mutation\n}\n'})}),"\n",(0,i.jsx)(t.h2,{id:"keepaliveinterval",children:"keepAliveInterval"}),"\n",(0,i.jsx)(t.p,{children:"The time in seconds between each keep-alive message sent to maintain the connection."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:"showLineNumbers",children:'schema @upstream(keepAliveInterval: 60, baseURL: "http://jsonplaceholder.typicode.com") {\n  query: Query\n  mutation: Mutation\n}\n'})}),"\n",(0,i.jsx)(t.h2,{id:"keepalivetimeout",children:"keepAliveTimeout"}),"\n",(0,i.jsx)(t.p,{children:"The time in seconds that the connection will wait for a keep-alive message before closing."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:"showLineNumbers",children:'schema @upstream(keepAliveTimeout: 60, baseURL: "http://jsonplaceholder.typicode.com") {\n  query: Query\n  mutation: Mutation\n}\n'})}),"\n",(0,i.jsx)(t.h2,{id:"keepalivewhileidle",children:"keepAliveWhileIdle"}),"\n",(0,i.jsx)(t.p,{children:"A boolean value that determines whether keep-alive messages should be sent while the connection is idle."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:"showLineNumbers",children:'schema @upstream(keepAliveWhileIdle: false, baseURL: "http://jsonplaceholder.typicode.com") {\n  query: Query\n  mutation: Mutation\n}\n'})}),"\n",(0,i.jsx)(t.h2,{id:"proxy",children:"proxy"}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"proxy"})," setting defines an intermediary server through which the upstream requests will be routed before reaching their intended endpoint. By specifying a proxy URL, you introduce an additional layer, enabling custom routing and security policies."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:"showLineNumbers",children:'schema @upstream(proxy: {url: "http://localhost:3000"}, baseURL: "http://jsonplaceholder.typicode.com") {\n  query: Query\n  mutation: Mutation\n}\n'})}),"\n",(0,i.jsxs)(t.p,{children:["In the provided example, we've set the proxy's ",(0,i.jsx)(t.code,{children:"url"}),' to "',(0,i.jsx)(t.a,{href:"http://localhost:3000",children:"http://localhost:3000"}),'". This configuration ensures that all requests aimed at the designated ',(0,i.jsx)(t.code,{children:"baseURL"})," are first channeled through this proxy. To illustrate, if the ",(0,i.jsx)(t.code,{children:"baseURL"}),' is "',(0,i.jsx)(t.a,{href:"http://jsonplaceholder.typicode.com",children:"http://jsonplaceholder.typicode.com"}),'", any request targeting it would be initially sent to "',(0,i.jsx)(t.a,{href:"http://localhost:3000",children:"http://localhost:3000"}),'" before being redirected to its final destination.']}),"\n",(0,i.jsx)(t.h2,{id:"connecttimeout",children:"connectTimeout"}),"\n",(0,i.jsx)(t.p,{children:"The time in seconds that the connection will wait for a response before timing out."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:"showLineNumbers",children:'schema @upstream(connectTimeout: 60, baseURL: "http://jsonplaceholder.typicode.com") {\n  query: Query\n  mutation: Mutation\n}\n'})}),"\n",(0,i.jsx)(t.h2,{id:"timeout",children:"timeout"}),"\n",(0,i.jsx)(t.p,{children:"The maximum time in seconds that the connection will wait for a response."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:"showLineNumbers",children:'schema @upstream(timeout: 60, baseURL: "http://jsonplaceholder.typicode.com") {\n  query: Query\n  mutation: Mutation\n}\n'})}),"\n",(0,i.jsx)(t.h2,{id:"tcpkeepalive",children:"tcpKeepAlive"}),"\n",(0,i.jsx)(t.p,{children:"The time in seconds between each TCP keep-alive message sent to maintain the connection."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:"showLineNumbers",children:'schema @upstream(tcpKeepAlive: 60, baseURL: "http://jsonplaceholder.typicode.com") {\n  query: Query\n  mutation: Mutation\n}\n'})}),"\n",(0,i.jsx)(t.h2,{id:"useragent",children:"userAgent"}),"\n",(0,i.jsx)(t.p,{children:"The User-Agent header value to be used in HTTP requests."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:"showLineNumbers",children:'schema @upstream(userAgent: "Tailcall/1.0", baseURL: "http://jsonplaceholder.typicode.com") {\n  query: Query\n  mutation: Mutation\n}\n'})}),"\n",(0,i.jsx)(t.h2,{id:"allowedheaders",children:"allowedHeaders"}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"allowedHeaders"})," configuration specifies which HTTP headers are permitted to be forwarded to upstream services when making requests.\nIf ",(0,i.jsx)(t.code,{children:"allowedHeaders"})," isn't specified, no incoming headers will be forwarded to the upstream services, which can provide an added layer of security but might restrict essential data flow."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:"showLineNumbers",children:'schema @upstream(allowedHeaders: ["Authorization", "X-Api-Key"]) {\n  query: Query\n  mutation: Mutation\n}\n'})}),"\n",(0,i.jsxs)(t.p,{children:["In the example above, the ",(0,i.jsx)(t.code,{children:"allowedHeaders"})," is set to allow only ",(0,i.jsx)(t.code,{children:"Authorization"})," and ",(0,i.jsx)(t.code,{children:"X-Api-Key"})," headers. This means that requests containing these headers will forward them to upstream services, while all others will be ignored. It ensures that only expected headers are communicated to dependent services, emphasizing security and consistency."]}),"\n",(0,i.jsx)(t.h2,{id:"baseurl",children:"baseURL"}),"\n",(0,i.jsxs)(t.p,{children:["This refers to the default base URL for your APIs. If it's not explicitly mentioned in the ",(0,i.jsx)(t.code,{children:"@upstream"})," operator, then each ",(0,i.jsx)(t.a,{href:"#http",children:"@http"})," operator must specify its own ",(0,i.jsx)(t.code,{children:"baseURL"}),". If neither ",(0,i.jsx)(t.code,{children:"@upstream"})," nor ",(0,i.jsx)(t.a,{href:"#http",children:"@http"})," provides a ",(0,i.jsx)(t.code,{children:"baseURL"}),", it results in a compilation error."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:"showLineNumbers",children:'schema @upstream(baseURL: "http://jsonplaceholder.typicode.com") {\n  query: Query\n  mutation: Mutation\n}\n'})}),"\n",(0,i.jsxs)(t.p,{children:["In this representation, the ",(0,i.jsx)(t.code,{children:"baseURL"})," is set as ",(0,i.jsx)(t.code,{children:"http://jsonplaceholder.typicode.com"}),". Thus, all API calls made by ",(0,i.jsx)(t.code,{children:"@http"})," will prepend this URL to their respective paths."]}),"\n",(0,i.jsxs)(t.admonition,{type:"tip",children:[(0,i.jsx)(t.p,{children:"Ensure that your base URL remains free from specific path segments."}),(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"GOOD:"})," ",(0,i.jsx)(t.code,{children:"@upstream(baseURL: http://jsonplaceholder.typicode.com)"})]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"BAD:"})," ",(0,i.jsx)(t.code,{children:"@upstream(baseURL: http://jsonplaceholder.typicode.com/api)"})]}),"\n"]})]}),"\n",(0,i.jsx)(t.h2,{id:"httpcache",children:"httpCache"}),"\n",(0,i.jsxs)(t.p,{children:["When activated, directs Tailcall to utilize HTTP caching mechanisms. These mechanisms, in accordance with the ",(0,i.jsx)(t.a,{href:"https://tools.ietf.org/html/rfc7234",children:"HTTP Caching RFC"}),", are designed to improve performance by reducing unnecessary data fetches. If left unspecified, this feature defaults to ",(0,i.jsx)(t.code,{children:"false"}),"."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:"showLineNumbers",children:"schema @upstream(httpCache: false) {\n  query: Query\n  mutation: Mutation\n}\n"})}),"\n",(0,i.jsx)(t.h3,{id:"tips",children:"Tips"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Only use batching if necessary and other optimization techniques don't resolve performance issues."}),"\n",(0,i.jsx)(t.li,{children:"Use batching judiciously and monitor its impact."}),"\n",(0,i.jsx)(t.li,{children:"Be aware that batching can complicate debugging"}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"batch",children:"batch"}),"\n",(0,i.jsxs)(t.p,{children:["An object that specifies the batch settings, including ",(0,i.jsx)(t.code,{children:"maxSize"})," (the maximum size of the batch), ",(0,i.jsx)(t.code,{children:"delay"})," (the delay in milliseconds between each batch), and ",(0,i.jsx)(t.code,{children:"headers"})," (an array of HTTP headers to be included in the batch)."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-graphql",metastring:"showLineNumbers",children:'schema @upstream(batch: {maxSize: 1000, delay: 10, headers: ["X-Server", "Authorization"]}) {\n  query: Query\n  mutation: Mutation\n}\n'})})]})}function d(e={}){const{wrapper:t}={...(0,s.a)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},1151:(e,t,n)=>{n.d(t,{Z:()=>o,a:()=>r});var i=n(7294);const s={},a=i.createContext(s);function r(e){const t=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(a.Provider,{value:t},e.children)}}}]);